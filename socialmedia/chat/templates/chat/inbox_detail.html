<div class="chat_container">

<div class="message-content-scrolbar" data-simplebar>

    <!-- Message Content Inner -->
    <div class="message-content-inner chat_container">
        <!-- Time Sign -->
        <div class="message-time-sign">
            <span>28 June, 2020</span>
        </div>
        {%for m in message_list%}
        {%if m.sender == request.user%}
        <div class="message-bubble me">
            <div class="message-bubble-inner">
                <div class="message-text">
                    <p>{{m.message}} - {{ m.sender.username }}</p>
                    {% if m.image %}
                        <img src="{{m.image.url}}" alt="" style="width: 100px;">
                    {% endif %}
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        
        {%else%}

        <div class="message-bubble">
            <div class="message-bubble-inner">
                <div class="message-text">
                    <p>{{m.message}} - {{ m.sender.username }}</p>
                    {% if m.image %}
                        <img src="{{m.image.url}}" alt="" style="width: 100px;">
                    {% endif %}
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        {%endif%}
        {%endfor%}
        <div id="chat-messages"></div>
    </div>

</div>
<div class="message-reply">
    <textarea id="chat-input" cols="20" rows="20" placeholder="Write Message"></textarea>
    <input type="file" name="image" accept="image/*" id="file-input">
    <button id="send-btn" class="button ripple-effect" >Send</button>
</div>  

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(function() {
        
        var receiver = "{{ receiver.username }}"
        const pathname = window.location.pathname;

        const parts = pathname.split('/');
        const username = parts[parts.length - 2];

       
        var socket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + receiver + '/');

        socket.onopen = function() {
            console.log('WebSocket connection established.');
        }

        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);
            var message = data.message;
            var receiver = data.receiver;
            var sender = data.sender;
            var image = data.image;
            var profileImage = data.profile_image;

            if (sender === "{{sender}}") {
                    var chatMessage = '<div class="message-bubble me">';
                    chatMessage += '<div class="message-bubble-inner">';
                    chatMessage += '<div class="message-avatar"><img src="' + profileImage + '" alt="" style="width: 50px;"></div>';
                    chatMessage += '<div class="message-text">';
                    chatMessage += '<p>' + message + '</p>';
                    chatMessage += '<img src="' + image + '" alt="" style="width: 100px;">';
                    chatMessage += '</div>';
                    chatMessage += '</div>';
                    chatMessage += '<div class="clearfix"></div>';
                    chatMessage += '</div>';
                    // Append the chat message to the main div
                    $('#chat-messages').append(chatMessage);
                    // Get the chat container
                    var chatContainer = document.querySelector('.chat_container');
                    // Automatically scroll to the bottom of the message after sending.
                    chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                var chatMessage = '<div class="message-bubble">';
                    chatMessage += '<div class="message-bubble-inner">';
                    chatMessage += '<div class="message-avatar"><img src="' + profileImage + '" alt="" style="width: 50px;"></div>';
                    chatMessage += '<div class="message-text">';
                    chatMessage += '<p>' + message + '</p>';
                    chatMessage += '<img src="' + image + '" alt="" style="width: 100px;">';
                    chatMessage += '</div>';
                    chatMessage += '</div>';
                    chatMessage += '<div class="clearfix"></div>';
                    chatMessage += '</div>';
                    $('#chat-messages').append(chatMessage);

                    var chatContainer = document.querySelector('.chat_container');
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    console.log("No");
            }
        }

        socket.onclose = function() {
            console.log('WebSocket connection closed.');
        }

        $('#send-btn').on('click', function() {
            var input = $('#chat-input');
            var message = input.val();
            var receiver = "{{ receiver.username }}"
            var sender = "{{request.user.username}}"; 
            var fileInput = document.getElementById('file-input');
            var file = fileInput.files[0];
console.log(username);
            if (file) {
                var reader = new FileReader();    
                reader.readAsDataURL(file);
                reader.onloadend = function() {
                    var imageData = reader.result;
                    var data = {               
                        'message': message,
                        'sender': sender,
                        'receiver': receiver,
                        'image': imageData, // Thêm dữ liệu hình ảnh dưới dạng chuỗi Base64
                    };
                    socket.send(JSON.stringify(data));
                };

            } else {
                var data = {               
                    'message': message,
                    'sender': sender,
                    'receiver': receiver,
                    'image': null, // Đặt giá trị image là null nếu không có hình ảnh
                };
                socket.send(JSON.stringify(data));
            }
            
            input.val('');
            var sendButton = $('#send-btn');
            sendButton.prop('disabled', true);
            $(".chat_container").scrollTop(100000000000);
        });

    });


    $(document).ready(function() {
      $(".chat_container").scrollTop(100000000000);
    });

</script>

<script>
    $(document).ready(function() {
         var chatInputValue = $('#chat-input');
         var sendButton = $('#send-btn');

         // Disable the button initially
         sendButton.prop('disabled', true);

         // Check input field on keyup event
         chatInputValue.on('keyup', function() {
             var inputText = $(this).val();

             // Enable/disable button based on input field value
             if (inputText.trim() !== '') {
                 sendButton.prop('disabled', false);
             } else {
                 sendButton.prop('disabled', true);
             }
         });
     })
 </script>


