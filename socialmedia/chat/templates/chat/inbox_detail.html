{% extends 'base_generic.html' %}
{% load static %}
{% block content %}
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />


<div class="content-chat" >
    <div class="row clearfix">
        <div class="col-lg-12">
            <div class="card chat-app">
                <div id="plist" class="people-list ">
                    <div class="input-group ">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" placeholder="Search...">
                    </div>
                    <div class="list-user overflow-auto scroll-smooth">
                        <div class="d-block">
                            <ul class="list-unstyled chat-list mt-2 mb-0">
                                {% for user_item in combined_list %}
                                    {% if user_item.type == "user"  %}
                                    <a href="{% url 'inbox_detail' user_item.object.username %}">
                                        <li class="clearfix "  {% if user_item.object.username == receiver.username %} id="active" {% endif %}>
                                            {% for profile in profiles %}   
                                                {% if user_item.object == profile.user %}             
                                                    <img src="{% if profile.profile_pic %}
                                                        {{ profile.profile_pic.url  }}
                                                    {% else %} 
                                                        https://scontent.fsgn2-3.fna.fbcdn.net/v/t1.30497-1/143086968_2856368904622192_1959732218791162458_n.png?stp=cp0_dst-png_p60x60&_nc_cat=1&ccb=1-7&_nc_sid=2b6aad&_nc_eui2=AeE1vTPkHb-3caw-Qa8LcUBUso2H55p0AlGyjYfnmnQCUZJq8s60z2bWHjSCVInwd04OWKdpTROsfDIQw33wpZKQ&_nc_ohc=x-5IH6VdBkQAX973AOb&_nc_ht=scontent.fsgn2-3.fna&oh=00_AfDK83mRdv0PL08D0btIF9cOTS3s8hnIALTSupH9AKV5XQ&oe=657722F8
                                                    {% endif %}" 
                                                    alt="avatar" style="width: 50px; " >
                                                {% endif %}
                                            {% endfor %}
                                            <div class="about">
                                                <div class="name" style="text-transform: capitalize;">{{user_item.object.username}}</div>
                                            </div>
                                        </li>
                                    </a>
                                    {% else %}
                                    <a href="{% url 'inbox_room_detail' user_item.object.name %}">
                                        <li class="clearfix ">                                            
                                            {% if user_item.object.image %}             
                                                <img src="{{ user_item.object.image.url  }}" alt="avatar" style="width: 40px; " >
                                            {% else %}
                                                <img src="{% static 'room.png' %}" alt=""  style="width: 40px;">
                                            {% endif %}
                                            <div class="about">
                                                <div class="name" style="text-transform: capitalize;">{{user_item.object.name}}</div>
                                            </div>
                                        </li>
                                    </a>
                                    {% endif %}
                                {% endfor %}                                
                            </ul>
                        </div>
                    </div>
                </div>
                    <div class="chat">
                        <div class="chat-header clearfix">
                            <div class="row">
                                <div class="col-lg-6">
                                    <a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
                                        {% for profile in profiles %}   
                                                {% if receiver == profile.user %}             
                                                    <img src="{% if profile.profile_pic %}
                                                        {{ profile.profile_pic.url  }}
                                                    {% else %} 
                                                        https://scontent.fsgn2-3.fna.fbcdn.net/v/t1.30497-1/143086968_2856368904622192_1959732218791162458_n.png?stp=cp0_dst-png_p60x60&_nc_cat=1&ccb=1-7&_nc_sid=2b6aad&_nc_eui2=AeE1vTPkHb-3caw-Qa8LcUBUso2H55p0AlGyjYfnmnQCUZJq8s60z2bWHjSCVInwd04OWKdpTROsfDIQw33wpZKQ&_nc_ohc=x-5IH6VdBkQAX973AOb&_nc_ht=scontent.fsgn2-3.fna&oh=00_AfDK83mRdv0PL08D0btIF9cOTS3s8hnIALTSupH9AKV5XQ&oe=657722F8
                                                    {% endif %}"
                                                    alt="avatar">
                                                {% endif %}
                                        {% endfor %}
                                    </a>
                                    <div class="chat-about">
                                        <h6 class="m-b-0">{{ receiver.username }}</h6>
                                    </div>
                                </div>
                                <div class="col-lg-6 hidden-sm text-end">
                                    <a href="javascript:void(0);" class="btn btn-outline-secondary"><i class="fa fa-camera"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-info"><i class="fa fa-cogs"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-warning"><i class="fa fa-question"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="chat-history overflow-auto scroll-smooth">
                            <div class="d-block">
                                <ul class="m-b-0" id="chat-messages">
                                    {% for message in message_list %}
                                        {% if message.sender == request.user %}
                                            <li class="clearfix">
                                                <div class="message-data text-end">
                                                    <span class="message-data-time">{{message.date}}</span>
                                                    {% for profile in profiles %}   
                                                        {% if message.sender == profile.user %}             
                                                            <img src="{% if profile.profile_pic %}
                                                                {{ profile.profile_pic.url  }}
                                                            {% else %} 
                                                                https://scontent.fsgn2-3.fna.fbcdn.net/v/t1.30497-1/143086968_2856368904622192_1959732218791162458_n.png?stp=cp0_dst-png_p60x60&_nc_cat=1&ccb=1-7&_nc_sid=2b6aad&_nc_eui2=AeE1vTPkHb-3caw-Qa8LcUBUso2H55p0AlGyjYfnmnQCUZJq8s60z2bWHjSCVInwd04OWKdpTROsfDIQw33wpZKQ&_nc_ohc=x-5IH6VdBkQAX973AOb&_nc_ht=scontent.fsgn2-3.fna&oh=00_AfDK83mRdv0PL08D0btIF9cOTS3s8hnIALTSupH9AKV5XQ&oe=657722F8
                                                            {% endif %}"
                                                            alt="avatar">
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="message other-message float-right"> 
                                                    {{message.message}} 
                                                    {% if message.image %}
                                                    <br>
                                                    <img src="{{ message.image.url }}" alt="" style="width: 300px;">
                                                    {% endif %} 
                                                    {% if message.video %}
                                                    <br>
                                                    <video controls style="width: 300px;"><source src="{{ message.video.url }}" type="video/mp4"> </video></div>
                                                    {% endif %}
                                                </div>
                                            </li>
                                        {% else %}
                                            <li class="clearfix">
                                                <div class="message-data text-start">
                                                    {% for profile in profiles %}   
                                                        {% if message.sender == profile.user %}             
                                                            <img src="{% if profile.profile_pic %}
                                                                {{ profile.profile_pic.url  }}
                                                            {% else %} 
                                                                https://scontent.fsgn2-3.fna.fbcdn.net/v/t1.30497-1/143086968_2856368904622192_1959732218791162458_n.png?stp=cp0_dst-png_p60x60&_nc_cat=1&ccb=1-7&_nc_sid=2b6aad&_nc_eui2=AeE1vTPkHb-3caw-Qa8LcUBUso2H55p0AlGyjYfnmnQCUZJq8s60z2bWHjSCVInwd04OWKdpTROsfDIQw33wpZKQ&_nc_ohc=x-5IH6VdBkQAX973AOb&_nc_ht=scontent.fsgn2-3.fna&oh=00_AfDK83mRdv0PL08D0btIF9cOTS3s8hnIALTSupH9AKV5XQ&oe=657722F8
                                                            {% endif %}"
                                                            alt="avatar">
                                                        {% endif %}
                                                    {% endfor %}
                                                    <span class="message-data-time">{{message.date}}</span>
                                                </div>
                                                <div class="message my-message"> 
                                                    {{message.message}}                                         
                                                    {% if message.image %}
                                                    <br>
                                                    <img src="{{ message.image.url }}" alt="" style="width: 300px;">
                                                    {% endif %}
                                                    {% if message.video %}
                                                    <br>
                                                    <video controls style="width: 300px;"><source src="{{ message.video.url }}" type="video/mp4"> </video>
                                                    {% endif %}
                                                </div>
                                            </li>
                                        {% endif %}
                                    {% endfor %}                                
                                </ul>
                            </div>
                        </div>
                        <div class="chat-message clearfix ">
                            <div class="input-group mb-0">
                                <div class="input-group-prepend" style="display: flex; ">
                                    <button class="input-group-text" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" style="margin: 5px; padding: 1rem;">
                                        <i class="fa fa-image"></i>
                                    </button>
                                    <input type="text" class="form-control" id="chat-input" placeholder="Enter text here...">      
                                    <ul class="dropdown-menu dropdown-menu-start  w-25" aria-labelledby="dropdownMenuButton" style="width: fit-content;">
                                        <label for="image">image</label>
                                        <input type="file" name="image"  accept="image/*" id="file-image">
                                        <label for="video">video</label>
                                        <input type="file" name="video"  accept="video/*" id="file-video">   
                                    </ul>                            
                                    <button class="input-group-text" style="margin: 5px; padding: 1rem;" id="send-btn">
                                    <i class="fa fa-send"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(function() {
        
        var receiver = null;
        var receiver_id = "{{ receiver.username }}"; 
        var logged_in = "{{ request.user.username }}"; 

        const pathname = window.location.pathname;
        const parts = pathname.split('/');
        const username = parts[parts.length - 2];

        if (receiver_id === logged_in) {
            receiver = receiver_id;
        } else {
            receiver = receiver_id;
        }

        var socket = new WebSocket('ws://' + window.location.host + '/ws/chat-private/' + receiver + '/');
        console.log(socket);

        socket.onopen = function() {
            console.log('WebSocket connection established.');
        }

        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);           
            var message = data.message;
            var receiver = data.receiver;
            var sender = data.sender;
            var image = data.image;
            var video = data.video;
            var profileImage = data.profile_image;
            if  (sender === "{{sender}}") {
                var chatMessage = '<li class="clearfix">';
                    chatMessage += ' <div class="message-data text-end">';
                    chatMessage += '<span class="message-data-time">10:10 AM, Today</span>'
                    chatMessage +='</div>'
                    chatMessage +='<div class="message other-message float-right">' + message 
                    if(image){
                        chatMessage += '<img src="' + image + '" alt="" style="width: 300px;"></div>';
                    }
                    if(video){
                        chatMessage += '<video controls style="width: 300px;"><source src='+ video + ' type="video/mp4"> </video></div>' ;                            
                    }    
                    chatMessage +='</li>'

                    // Append the chat message to the main div
                    $('#chat-messages').append(chatMessage);
                    
                    

            } else{
                var chatMessage = '<li class="clearfix">';
                    chatMessage += ' <div class="message-data text-start">';
                    chatMessage += '<span class="message-data-time">10:10 AM, Today</span>'
                    chatMessage +='</div>'
                    chatMessage +='<div class="message my-message ">' + message + '</div>'
                    if(image){
                        chatMessage += '<img src="' + image + '" alt="" style="width: 100px;">';
                    }
                    if(video){
                        chatMessage += '<video controls><source src='+ video + ' type="video/mp4"> </video>' ;                            
                    }    
                    chatMessage +='</li>'

                    // Append the chat message to the main div
                    $('#chat-messages').append(chatMessage);
            }
           
        }

        socket.onclose = function() {
            console.log('WebSocket connection closed.');
        }

        $('#send-btn').on('click', function() {
            var input = $('#chat-input');
            var message = input.val();
            var receiver = "{{ receiver.username }}"
            var sender = "{{request.user.username}}"; 
            var fileImage = document.getElementById('file-image');
            var fileVideo = document.getElementById('file-video');
            var file = fileImage.files[0] || fileVideo.files[0];
            if (file) {
                var reader = new FileReader();    
                reader.readAsDataURL(file);
                reader.onloadend = function() {
                    var fileData = reader.result;
                    var fileType = file.type;
                    var data = {               
                        'message': message,
                        'sender': sender,
                        'receiver': receiver,                        
                        'fileData': fileData, // Dữ liệu của hình ảnh hoặc video dưới dạng chuỗi Base64
                        'fileType': fileType,
                    };
                    socket.send(JSON.stringify(data));
                };

            } else {
                var data = {               
                    'message': message,
                    'sender': sender,
                    'receiver': receiver,
                    'fileData': null, // Đặt giá trị fileData là null nếu không có file nào được chọn
                    'fileType': null,
                };
                socket.send(JSON.stringify(data));
            }
            
            input.val('');
            $('#file-image').val('');
            $('#file-video').val('');
        
            var sendButton = $('#send-btn');       
            $(".chat-history").scrollTop(100000000000);
                });
        
            });   
           
        $(document).ready(function() {
            $(".chat-history").scrollTop(100000000000);
        });     
    
    
            
  

</script>

{% endblock %}